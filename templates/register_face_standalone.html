<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Rostro - Sistema de Asistencias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        #video {
            transform: scaleX(-1);
        }
        #canvas {
            display: none;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #capturedImage {
            display: none;
            transform: scaleX(-1);
        }
        .step {
            transition: all 0.3s ease;
        }
        .step.active {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Progress Bar -->
    <div class="bg-white shadow-md">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between text-sm">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center">
                        <i class="fas fa-check"></i>
                    </div>
                    <span class="text-gray-700 font-semibold">Registro Completado</span>
                </div>
                <div class="flex-1 mx-4 h-1 bg-gray-300 rounded">
                    <div id="progressBar" class="h-full bg-blue-600 rounded transition-all duration-500" style="width: 0%"></div>
                </div>
                <div class="flex items-center space-x-2">
                    <div id="faceIcon" class="w-8 h-8 bg-gray-300 text-white rounded-full flex items-center justify-center">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <span class="text-gray-500">Registro Facial</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Welcome Section -->
        <div class="text-center mb-8">
            <div class="inline-block bg-white rounded-full p-4 shadow-lg mb-4">
                <i class="fas fa-user-check text-5xl text-blue-600"></i>
            </div>
            <h1 class="text-4xl font-bold text-gray-800 mb-3">
                ¡Bienvenido, <span class="text-blue-600">{{ empleado.nombre_completo }}</span>!
            </h1>
            <p class="text-gray-600 text-lg">
                Tu cuenta ha sido creada exitosamente. Ahora registra tu rostro para poder marcar asistencia.
            </p>
        </div>

        <!-- Main Card -->
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div class="grid md:grid-cols-5 gap-0">
                <!-- Left Panel - Steps -->
                <div class="md:col-span-2 bg-gradient-to-br from-blue-600 to-indigo-700 p-8 text-white">
                    <h2 class="text-2xl font-bold mb-6">Pasos a Seguir</h2>
                    
                    <div class="space-y-6">
                        <div class="step flex items-start" data-step="1">
                            <div class="flex-shrink-0 w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-4">
                                <span class="font-bold text-lg">1</span>
                            </div>
                            <div>
                                <h3 class="font-bold mb-1">Activar Cámara</h3>
                                <p class="text-blue-100 text-sm">Permite el acceso a tu cámara web</p>
                            </div>
                        </div>

                        <div class="step flex items-start" data-step="2">
                            <div class="flex-shrink-0 w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-4">
                                <span class="font-bold text-lg">2</span>
                            </div>
                            <div>
                                <h3 class="font-bold mb-1">Posicionarte Bien</h3>
                                <p class="text-blue-100 text-sm">Centra tu rostro con buena iluminación</p>
                            </div>
                        </div>

                        <div class="step flex items-start" data-step="3">
                            <div class="flex-shrink-0 w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-4">
                                <span class="font-bold text-lg">3</span>
                            </div>
                            <div>
                                <h3 class="font-bold mb-1">Capturar Foto</h3>
                                <p class="text-blue-100 text-sm">Toma una foto clara de tu rostro</p>
                            </div>
                        </div>

                        <div class="step flex items-start" data-step="4">
                            <div class="flex-shrink-0 w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-4">
                                <span class="font-bold text-lg">4</span>
                            </div>
                            <div>
                                <h3 class="font-bold mb-1">Registrar</h3>
                                <p class="text-blue-100 text-sm">Confirma y guarda tu rostro</p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 pt-8 border-t border-white border-opacity-20">
                        <h3 class="font-bold mb-3">
                            <i class="fas fa-lightbulb mr-2"></i>Consejos
                        </h3>
                        <ul class="space-y-2 text-sm text-blue-100">
                            <li><i class="fas fa-check mr-2"></i>Usa luz natural o frontal</li>
                            <li><i class="fas fa-check mr-2"></i>Evita sombras en el rostro</li>
                            <li><i class="fas fa-check mr-2"></i>Mira directamente a la cámara</li>
                            <li><i class="fas fa-check mr-2"></i>Mantén expresión neutral</li>
                        </ul>
                    </div>
                </div>

                <!-- Right Panel - Camera & Actions -->
                <div class="md:col-span-3 p-8">
                    <!-- Camera Status -->
                    <div class="mb-4 text-center">
                        <span id="cameraStatus" class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold">
                            <i class="fas fa-circle text-red-500 animate-pulse mr-2"></i>
                            Cámara Desactivada
                        </span>
                    </div>

                    <!-- Video/Image Preview -->
                    <div class="relative bg-gray-900 rounded-xl overflow-hidden mb-6 shadow-lg">
                        <video id="video" autoplay playsinline class="w-full aspect-video object-cover"></video>
                        <img id="capturedImage" class="w-full aspect-video object-cover" alt="Foto capturada">
                        <div id="videoPlaceholder" class="w-full aspect-video flex items-center justify-center bg-gray-800">
                            <div class="text-center text-gray-400">
                                <i class="fas fa-camera text-6xl mb-4 opacity-50"></i>
                                <p class="text-lg font-semibold">Haz clic en "Activar Cámara"</p>
                                <p class="text-sm mt-2">para comenzar el registro facial</p>
                            </div>
                        </div>
                    </div>

                    <canvas id="canvas"></canvas>

                    <!-- Action Buttons -->
                    <div class="space-y-3">
                        <!-- Start Camera -->
                        <button id="startCamera" class="w-full bg-green-600 hover:bg-green-700 text-white px-6 py-4 rounded-xl font-bold text-lg transition transform hover:scale-105 shadow-lg">
                            <i class="fas fa-video mr-2"></i>Activar Cámara
                        </button>

                        <!-- Stop Camera (hidden) -->
                        <button id="stopCamera" class="hidden w-full bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-xl font-semibold transition">
                            <i class="fas fa-video-slash mr-2"></i>Detener Cámara
                        </button>

                        <!-- Capture Button -->
                        <button id="captureBtn" disabled class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white px-6 py-4 rounded-xl font-bold text-lg transition transform hover:scale-105 shadow-lg">
                            <i class="fas fa-camera mr-2"></i>Capturar Rostro
                        </button>

                        <!-- Retake Button (hidden) -->
                        <button id="retakeBtn" class="hidden w-full bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-xl font-semibold transition">
                            <i class="fas fa-redo mr-2"></i>Tomar Otra Foto
                        </button>

                        <!-- Register Button (hidden) -->
                        <button id="registerBtn" class="hidden w-full bg-green-600 hover:bg-green-700 text-white px-6 py-4 rounded-xl font-bold text-lg transition transform hover:scale-105 shadow-lg">
                            <i class="fas fa-check-circle mr-2"></i>Registrar Mi Rostro
                        </button>

                        <!-- Skip Button -->
                        <button id="skipBtn" class="w-full bg-white hover:bg-gray-50 text-gray-700 border-2 border-gray-300 px-6 py-3 rounded-xl font-semibold transition">
                            <i class="fas fa-forward mr-2"></i>Saltar por Ahora
                        </button>
                    </div>

                    <!-- Loading -->
                    <div id="loading" class="hidden text-center py-6 mt-4">
                        <div class="loader mb-3"></div>
                        <p class="text-gray-600 font-semibold">Procesando y validando tu rostro...</p>
                        <p class="text-gray-500 text-sm mt-1">Esto puede tomar unos segundos</p>
                    </div>

                    <!-- Result Message -->
                    <div id="result" class="hidden rounded-lg p-4 mt-4"></div>
                </div>
            </div>
        </div>

        <!-- Footer Info -->
        <div class="mt-8 text-center text-gray-600 text-sm">
            <p>
                <i class="fas fa-shield-alt mr-1"></i>
                Tu imagen será procesada de forma segura y solo se usará para control de asistencias
            </p>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const capturedImage = document.getElementById('capturedImage');
        const videoPlaceholder = document.getElementById('videoPlaceholder');
        
        const startCameraBtn = document.getElementById('startCamera');
        const stopCameraBtn = document.getElementById('stopCamera');
        const captureBtn = document.getElementById('captureBtn');
        const retakeBtn = document.getElementById('retakeBtn');
        const registerBtn = document.getElementById('registerBtn');
        const skipBtn = document.getElementById('skipBtn');
        
        const cameraStatus = document.getElementById('cameraStatus');
        const loading = document.getElementById('loading');
        const resultDiv = document.getElementById('result');
        const progressBar = document.getElementById('progressBar');
        const faceIcon = document.getElementById('faceIcon');
        
        let stream = null;
        let capturedBlob = null;
        let currentStep = 0;

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        function updateProgress(step) {
            currentStep = step;
            const progress = (step / 4) * 100;
            progressBar.style.width = progress + '%';
            
            // Update step highlighting
            document.querySelectorAll('.step').forEach((el, idx) => {
                if (idx < step) {
                    el.classList.add('active');
                } else {
                    el.classList.remove('active');
                }
            });
        }

        startCameraBtn.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    } 
                });
                video.srcObject = stream;
                video.style.display = 'block';
                videoPlaceholder.style.display = 'none';
                capturedImage.style.display = 'none';
                
                startCameraBtn.classList.add('hidden');
                stopCameraBtn.classList.remove('hidden');
                captureBtn.disabled = false;
                
                cameraStatus.className = 'inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-green-100 text-green-800';
                cameraStatus.innerHTML = '<i class="fas fa-circle text-green-500 animate-pulse mr-2"></i>Cámara Activa';
                
                updateProgress(1);
            } catch (err) {
                showResult('error', 'Error al acceder a la cámara: ' + err.message);
            }
        });

        stopCameraBtn.addEventListener('click', () => {
            stopCamera();
            resetCapture();
        });

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                video.style.display = 'none';
                videoPlaceholder.style.display = 'flex';
                
                startCameraBtn.classList.remove('hidden');
                stopCameraBtn.classList.add('hidden');
                captureBtn.disabled = true;
                
                cameraStatus.className = 'inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold';
                cameraStatus.innerHTML = '<i class="fas fa-circle text-red-500 animate-pulse mr-2"></i>Cámara Desactivada';
            }
        }

        function resetCapture() {
            capturedImage.style.display = 'none';
            video.style.display = stream ? 'block' : 'none';
            videoPlaceholder.style.display = stream ? 'none' : 'flex';
            
            captureBtn.classList.remove('hidden');
            retakeBtn.classList.add('hidden');
            registerBtn.classList.add('hidden');
            capturedBlob = null;
            
            if (stream) updateProgress(1);
        }

        captureBtn.addEventListener('click', () => {
            if (!stream) return;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            context.save();
            context.scale(-1, 1);
            context.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
            context.restore();
            
            canvas.toBlob((blob) => {
                capturedBlob = blob;
                
                const url = URL.createObjectURL(blob);
                capturedImage.src = url;
                capturedImage.style.display = 'block';
                video.style.display = 'none';
                
                captureBtn.classList.add('hidden');
                retakeBtn.classList.remove('hidden');
                registerBtn.classList.remove('hidden');
                
                updateProgress(3);
            }, 'image/jpeg', 0.95);
        });

        retakeBtn.addEventListener('click', () => {
            resetCapture();
        });

        registerBtn.addEventListener('click', async () => {
            if (!capturedBlob) {
                showResult('error', 'No hay foto capturada');
                return;
            }

            loading.classList.remove('hidden');
            registerBtn.disabled = true;
            retakeBtn.disabled = true;
            skipBtn.disabled = true;
            resultDiv.classList.add('hidden');

            try {
                const formData = new FormData();
                formData.append('foto_rostro', capturedBlob, 'rostro.jpg');

                const response = await fetch('/api/empleados/{{ empleado.pk }}/registrar-rostro-session/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                    },
                    body: formData
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    updateProgress(4);
                    faceIcon.className = 'w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center';
                    faceIcon.innerHTML = '<i class="fas fa-check"></i>';
                    
                    showResult('success', '¡Perfecto! ' + (data.message || 'Tu rostro ha sido registrado exitosamente'));
                    
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 3000);
                } else {
                    showResult('error', data.message || 'Error al registrar el rostro. Por favor intenta de nuevo.');
                    registerBtn.disabled = false;
                    retakeBtn.disabled = false;
                    skipBtn.disabled = false;
                }
            } catch (error) {
                showResult('error', 'Error de conexión: ' + error.message);
                registerBtn.disabled = false;
                retakeBtn.disabled = false;
                skipBtn.disabled = false;
            } finally {
                loading.classList.add('hidden');
            }
        });

        skipBtn.addEventListener('click', () => {
            if (confirm('¿Estás seguro de que deseas omitir el registro facial? Podrás registrarlo después desde tu perfil.')) {
                window.location.href = '/';
            }
        });

        function showResult(type, message) {
            resultDiv.classList.remove('hidden', 'bg-green-100', 'border-green-500', 'text-green-800', 'bg-red-100', 'border-red-500', 'text-red-800');
            
            if (type === 'success') {
                resultDiv.classList.add('bg-green-100', 'border-l-4', 'border-green-500', 'text-green-800');
                resultDiv.innerHTML = `<div class="flex items-center"><i class="fas fa-check-circle text-2xl mr-3"></i><div><p class="font-bold">${message}</p><p class="text-sm mt-1">Serás redirigido en unos segundos...</p></div></div>`;
            } else {
                resultDiv.classList.add('bg-red-100', 'border-l-4', 'border-red-500', 'text-red-800');
                resultDiv.innerHTML = `<div class="flex items-center"><i class="fas fa-exclamation-circle text-2xl mr-3"></i><p class="font-semibold">${message}</p></div>`;
            }
        }

        window.addEventListener('beforeunload', () => {
            stopCamera();
        });
    </script>
</body>
</html>
